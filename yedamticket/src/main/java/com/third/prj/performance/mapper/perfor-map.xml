<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.third.prj.performance.mapper.PerformanceMapper">

	<resultMap id="procedureCall" type="hashmap"/>

	<select id="perSelectList" resultType="com.third.prj.performance.service.PerformanceVO">
	SELECT P_NO,NAME,CONTENT,C_ID,ACTOR,FILE_CD,LOC,ADDR,PRICE
	FROM PERFORMANCE 
	</select>

	<select id="perSelect" resultType="com.third.prj.performance.service.PerformanceVO">
	SELECT P_NO,NAME,CONTENT,C_ID,ACTOR,FILE_CD,LOC,ADDR,PRICE
	FROM PERFORMANCE 
	WHERE p_no = #{PNo} 
	</select>


	<update id="procedureCall" statementType="CALLABLE">
	{CALL perfor_pro(#{vp_no, mode=IN, jdbcType=INTEGER, javaType=INT},
	                 #{p_name, mode=IN, jdbcType=VARCHAR, javaType=STRING},
	                 #{p_content, mode=IN, jdbcType=VARCHAR, javaType=STRING},
	                 #{p_actor, mode=IN, jdbcType=VARCHAR, javaType=STRING},
	                 #{p_loc, mode=IN, jdbcType=VARCHAR, javaType=STRING},
	                 #{p_addr, mode=IN, jdbcType=VARCHAR, javaType=STRING},
					 #{p_price, mode=IN, jdbcType=VARCHAR, javaType=STRING},
					 #{p_lname, mode=IN, jdbcType=VARCHAR, javaType=STRING},
					 #{p_vname, mode=IN, jdbcType=VARCHAR, javaType=STRING},
					 #{p_cd, mode=IN, jdbcType=VARCHAR, javaType=STRING},
					 #{p_message, mode=OUT, jdbcType=VARCHAR, javaType=STRING})} 
	</update>


	<!-- 황규복 -->
	<!-- performanceSch resultMap -->
	<resultMap type="com.third.prj.performanceschedule.service.PerformanceScheduleVO" id="pScheduleMap">
		<result column="frdt" property="frDt"/>
		<result column="time" property="time"/>
	</resultMap>
	<!-- performance resultMap -->
	<resultMap type="com.third.prj.performance.service.PerformanceVO" id="pMap">
		<result column="p_no" property="pNo"/>
		<result column="name" property="name"/>
		<result column="content" property="content"/>
		<result column="actor" property="actor"/>
		<result column="file_cd" property="fileCd"/>
		<result column="loc" property="loc"/>
		<result column="addr" property="addr"/>
		<result column="price" property="price"/>
		<collection property="performanceScheduleVO" resultMap="pScheduleMap"/>
	</resultMap>
	<!-- 공연 전체리스트  -->
	<select id="pList" resultMap="pMap">
	  	<![CDATA[
			SELECT * 
			FROM (
	    		SELECT ROWNUM RN, A.*
	    		FROM (
	    		
	    		 SELECT 
				 P.P_NO,P.NAME,P.CONTENT,P.ACTOR,P.FILE_CD,P.LOC,P.ADDR,P.PRICE,PS.FRDT,PS.TIME 
				 FROM PERFORMANCE P JOIN PERFORMANCE_SCHEDULE PS
				 ON 
				 P.P_NO = PS.P_NO 
		]]>	
		<where>
		<if test="frDt == null and name == null and loc == null">
		AND 1=1
		</if>
		<!-- 날짜만 입력받은 경우 -->
		<if test="frDt != null and frDt !=''">
		AND PS.FRDT = #{frDt}
		</if>
		<!-- 날짜 + 이벤트 -->
		<if test="name != null and name !=''" >
		AND P.NAME LIKE '%' || #{name} || '%'
		</if>
		<!-- 날짜 + 지역 -->
		<if test="loc != null and loc !=''">
		AND P.LOC  LIKE '%' || #{loc} || '%'
		</if>
	</where>
		<![CDATA[
	    		 ) A ) 
		         WHERE RN > (#{pageNum}-1) * #{amount} 
		         AND RN <= #{pageNum} * #{amount}
		]]>	
	</select>
	<!-- 예정공연  -->
	<select id="epList"  resultMap="pMap">
			SELECT 
			P.P_NO,P.NAME,P.CONTENT,P.ACTOR,P.FILE_CD,P.LOC,P.ADDR,P.PRICE,PS.FRDT,PS.TIME 
			FROM 
			PERFORMANCE P JOIN PERFORMANCE_SCHEDULE PS
			ON 
			P.P_NO = PS.P_NO
	        where FRDT > TO_CHAR(SYSDATE,'YY/MM/DD')
	        
	</select>
	
	<select id="getTotal" resultType="int">
		<![CDATA[
			SELECT COUNT(*) AS TOTAL 
			FROM (
	    		SELECT ROWNUM RN, A.*
	    		FROM (
	    		
	    		 SELECT 
				 P.P_NO,P.NAME,P.CONTENT,P.ACTOR,P.FILE_CD,P.LOC,P.ADDR,P.PRICE,PS.FRDT,PS.TIME 
				 FROM PERFORMANCE P JOIN PERFORMANCE_SCHEDULE PS
				 ON 
				 P.P_NO = PS.P_NO     
		]]>	
		<where>
		<if test="frDt == null and name == null and loc == null">
		AND 1=1
		</if>
		<!-- 날짜만 입력받은 경우 -->
		<if test="frDt != null and frDt !=''">
		AND PS.FRDT = #{frDt}
		</if>
		<!-- 날짜 + 이벤트 -->
		<if test="name != null and name !=''" >
		AND P.NAME LIKE '%' || #{name} || '%'
		</if>
		<!-- 날짜 + 지역 -->
		<if test="loc != null and loc !=''">
		AND P.LOC  LIKE '%' || #{loc} || '%'
		</if>
	</where>
		 ) A )
	</select>
	<!-- 공연선택 -->
	<select id="pSelect" resultMap="pMap">
		SELECT 
			P.P_NO,P.NAME,P.CONTENT,P.ACTOR,P.FILE_CD,P.LOC,P.ADDR,P.PRICE,PS.FRDT,PS.TIME 
			FROM 
			PERFORMANCE P JOIN PERFORMANCE_SCHEDULE PS
			ON 
			P.P_NO = PS.P_NO
	        WHERE P.NAME = #{name}
	</select>
</mapper>