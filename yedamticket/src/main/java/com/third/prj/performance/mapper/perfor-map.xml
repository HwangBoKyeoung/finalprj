<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.third.prj.performance.mapper.PerformanceMapper">

	<resultMap id="procedureCall" type="hashmap"/>

	<select id="perSelectList" resultType="com.third.prj.performance.service.PerformanceVO">
	SELECT P_NO,NAME,CONTENT,C_ID,ACTOR,FILE_CD,LOC,ADDR,PRICE
	FROM PERFORMANCE 
	</select>

	 <select id="perSelect" resultType="com.third.prj.performance.service.PerformanceVO">
	SELECT P_NO,NAME,CONTENT,C_ID,ACTOR,FILE_CD,LOC,ADDR,PRICE
	FROM PERFORMANCE 
	WHERE p_no = #{PNo} 
	</select> 


	<update id="procedureCall" statementType="CALLABLE">
	{CALL perfor_pro(#{vp_no, mode=IN, jdbcType=INTEGER, javaType=INT},
	                 #{p_name, mode=IN, jdbcType=VARCHAR, javaType=STRING},
	                 #{p_content, mode=IN, jdbcType=VARCHAR, javaType=STRING},
	                 #{p_actor, mode=IN, jdbcType=VARCHAR, javaType=STRING},
	                 #{p_loc, mode=IN, jdbcType=VARCHAR, javaType=STRING},
	                 #{p_addr, mode=IN, jdbcType=VARCHAR, javaType=STRING},
					 #{p_price, mode=IN, jdbcType=VARCHAR, javaType=STRING},
					 #{p_lname, mode=IN, jdbcType=VARCHAR, javaType=STRING},
					 #{p_vname, mode=IN, jdbcType=VARCHAR, javaType=STRING},
					 #{p_cd, mode=IN, jdbcType=VARCHAR, javaType=STRING},
					 #{p_message, mode=OUT, jdbcType=VARCHAR, javaType=STRING})} 
	</update>


	<!-- 황규복 -->
	<!-- performanceSch resultMap -->
	<resultMap type="com.third.prj.performanceschedule.service.PerformanceScheduleVO" id="pScheduleMap">
		<result property="PSchNo" column="P_SCH_NO"/>
		<result property="frDt" column="FRDT"/>
		<result property="trDt" column="TRDT"/>
		<result property="time" column="TIME"/>
		<result property="endTime" column="ENDTIME"/>
	</resultMap>
	<!-- performance resultMap -->
	<resultMap type="com.third.prj.performance.service.PerformanceVO" id="pMap">
		<result column="P_NO" property="pNo"/>
		<result column="NAME" property="name"/>
		<result column="CONTENT" property="content"/>
		<result column="ACTOR" property="actor"/>
		<result column="FILE_CD" property="fileCd"/>
		<result column="LOC" property="loc"/>
		<result column="ADDR" property="addr"/>
		<result column="PRICE" property="price"/>
		<result column="LAT" property="lat"/>
		<result column="LNG" property="lng"/>
		<collection property="performanceScheduleVO" resultMap="pScheduleMap"/>
	</resultMap>
	<!-- 공연 전체리스트  -->
	<select id="pList" resultMap="pMap">
	  	<![CDATA[
			SELECT * 
			FROM (
	    		SELECT ROWNUM RN, A.*
	    		FROM (
	    		
	    		 SELECT 
				 P.P_NO,P.NAME,P.CONTENT,P.ACTOR,P.FILE_CD,P.LOC,P.ADDR,P.PRICE,P.LAT,P.LNG,
				 PS.FRDT,PS.TRDT,PS.TIME,PS.ENDTIME 
				 FROM PERFORMANCE P JOIN PERFORMANCE_SCHEDULE PS
				 ON 
				 P.P_NO = PS.P_NO 
		]]>	
		<where>
		<if test="frDt == null and name == null and loc == null">
		AND 1=1
		</if>
		<!-- 날짜만 입력받은 경우 -->
		<if test="frDt != null and frDt !=''">
		AND PS.FRDT = #{frDt}
		</if>
		<!-- 날짜 + 이벤트 -->
		<if test="name != null and name !=''" >
		AND P.NAME LIKE '%' || #{name} || '%'
		</if>
		<!-- 날짜 + 지역 -->
		<if test="loc != null and loc !=''">
		AND P.LOC  LIKE '%' || #{loc} || '%'
		</if>
	</where>
		<![CDATA[
	    		 ) A ) 
		         WHERE RN > (#{pageNum}-1) * #{amount} 
		         AND RN <= #{pageNum} * #{amount}
		]]>	
	</select>
	<!-- 예정공연  -->
	<select id="epList"  resultMap="pMap">
			SELECT 
			P.P_NO,P.NAME,P.CONTENT,P.ACTOR,P.FILE_CD,P.LOC,P.ADDR,P.PRICE,P.LAT,P.LNG,
			PS.FRDT,PS.TRDT,PS.TIME,PS.ENDTIME 
			FROM 
			PERFORMANCE P JOIN PERFORMANCE_SCHEDULE PS
			ON 
			P.P_NO = PS.P_NO
	        where FRDT > TO_CHAR(SYSDATE,'YY/MM/DD')
	        
	</select>
	
	<select id="getTotal" resultType="int">
		<![CDATA[
			SELECT COUNT(*) AS TOTAL 
			FROM (
	    		SELECT ROWNUM RN, A.*
	    		FROM (
	    		
	    		 SELECT 
				 P.P_NO,P.NAME,P.CONTENT,P.ACTOR,P.FILE_CD,P.LOC,P.ADDR,P.PRICE,P.LAT,P.LNG,
				 PS.FRDT,PS.TRDT,PS.TIME,PS.ENDTIME 
				 FROM PERFORMANCE P JOIN PERFORMANCE_SCHEDULE PS
				 ON 
				 P.P_NO = PS.P_NO     
		]]>	
		<where>
		<if test="frDt == null and name == null and loc == null">
		AND 1=1
		</if>
		<!-- 날짜만 입력받은 경우 -->
		<if test="frDt != null and frDt !=''">
		AND PS.FRDT = #{frDt}
		</if>
		<!-- 날짜 + 이벤트 -->
		<if test="name != null and name !=''" >
		AND P.NAME LIKE '%' || #{name} || '%'
		</if>
		<!-- 날짜 + 지역 -->
		<if test="loc != null and loc !=''">
		AND P.LOC  LIKE '%' || #{loc} || '%'
		</if>
	</where>
		 ) A )
	</select>
	<!-- 공연선택 -->
	<select id="pSelect" resultMap="pMap">
		SELECT 
			P.P_NO,P.NAME,P.CONTENT,P.ACTOR,P.FILE_CD,P.LOC,P.ADDR,P.PRICE,P.LAT,P.LNG,
			PS.P_SCH_NO,PS.FRDT,PS.TRDT,PS.TIME,PS.ENDTIME 
			FROM 
			PERFORMANCE P JOIN PERFORMANCE_SCHEDULE PS
			ON 
			P.P_NO = PS.P_NO
	        WHERE P.P_NO = #{PNo}
	</select>
</mapper>